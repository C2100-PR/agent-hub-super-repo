name: Pinecone Integration

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

env:
  PINECONE_API_KEY: ${{ secrets.PINECONE_API_KEY }}
  PINECONE_ENVIRONMENT: gcp-us-central1-4a9f
  PINECONE_INDEX: multilingual-e5-large
  GCP_PROJECT_ID: api-for-warp-drive
  GCP_SA_KEY: ${{ secrets.GCP_SA_KEY }}

jobs:
  verify-connections:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v2
      
      - name: Set up Python
        uses: actions/setup-python@v2
        with:
          python-version: '3.9'
          
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install pinecone-client google-cloud-secret-manager

      - name: Authenticate to GCP
        uses: google-github-actions/auth@v0
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      - name: Verify GCP Secret Manager access
        run: |
          echo "Verifying GCP Secret Manager access..."
          python -c "from google.cloud import secretmanager; client = secretmanager.SecretManagerServiceClient()"

      - name: Verify Pinecone connection
        run: |
          python -c "
          import pinecone
          import os
          
          pinecone.init(
              api_key=os.getenv('PINECONE_API_KEY'),
              environment=os.getenv('PINECONE_ENVIRONMENT')
          )
          
          index = pinecone.Index(os.getenv('PINECONE_INDEX'))
          stats = index.describe_index_stats()
          print(f'Successfully connected to Pinecone: {stats}')
          "